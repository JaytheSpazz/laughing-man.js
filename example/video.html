<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }


    img {
      position: absolute;
      display: block;
      display: none;
      transition: all 0.5s;
    }

    video {
      max-width: 100vw;
    }
  </style>
</head>
<body>
  <img id="laughingMan" src="../img/laughing-man-animated.svg" alt="" />
  <video id="video" controls></video>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // const faceDetector = new FaceDetector({ fastMode: true, maxDetectedFaces: 1 })
    const faceDetector = new FaceDetector({ maxDetectedFaces: 1 })
    const laughingMan = document.querySelector('#laughingMan')
    let isDetectingFaces = false
    let faces = []
    let canvas
    let video = document.querySelector('video')
    let hideTimeout

    function createCanvas(video) {
      canvas = document.createElement('canvas')
      const videoCompStyle = window.getComputedStyle(video)
      canvas.width = videoCompStyle.width.replace('px', '')
      canvas.height = videoCompStyle.height.replace('px', '')
      canvas.style.display = 'none'
      document.querySelector('body').appendChild(canvas)
    }

    async function draw() {
      requestAnimationFrame(draw)
      const context = canvas.getContext('2d')
      const videoCompStyle = getComputedStyle(video)
      const videoWidth = videoCompStyle.width.replace('px', '')
      const videoHeight = videoCompStyle.height.replace('px', '')
      context.drawImage(video, 0, 0, videoWidth, videoHeight)

      if (faces.length) {
        const face = faces[0].boundingBox
        clearTimeout(hideTimeout)
        laughingMan.style.display = 'block'
        laughingMan.style.left = `${face.left - (face.width * 0.4)}px`
        laughingMan.style.top = `${face.top - (face.height * 0.6)}px`
        laughingMan.style.width = `${face.width * 1.8}px`
        laughingMan.style.height = `${face.height * 1.8}px`
      } else {
        clearTimeout(hideTimeout)
        hideTimeout = hideLaughingMan(laughingMan)
      }

      if (isDetectingFaces) return

      isDetectingFaces = true
      faces = await faceDetector.detect(canvas)
      console.log({faces})
      isDetectingFaces = false
    }

    function hideLaughingMan(laughingMan) {
      return setTimeout(() => {
        laughingMan.style.display = 'none'
        console.log('hide')
      }, 500)
    }

    async function main() {
      createCanvas(video)
      draw()
    }

  </script>
  <script>
     if (Hls.isSupported()) {
       const video = document.getElementById('video')
       const hls = new Hls()
       // const source = 'https://video.nyt.com/video-media/hls/2017/08/03/73616_1_00trump-immigration_wg/master.m3u8'
       // const source = 'https://vp.nyt.com/video/2017/08/08/73657_1_09trump-nkorea_wg_hls/master.m3u8'
       const source = 'https://video.nyt.com/video-media/hls/2017/08/04/73625_1_04sessions-leaks-presser_wg/master.m3u8'
       hls.loadSource(source)
       hls.attachMedia(video);
       hls.on(Hls.Events.MANIFEST_PARSED, async () => {
         await video.play();
         main()
     })
    }
  </script>
</body>
</html>
